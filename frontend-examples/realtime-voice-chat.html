<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å½•éŸ³è¯­éŸ³å¯¹è¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #48bb78;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        .status-dot.recording {
            background: #e53e3e;
        }
        
        .status-dot.processing {
            background: #d69e2e;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
        
        .record-section {
            text-align: center;
            padding: 40px;
            background: #f7fafc;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .record-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .record-button:not(.recording) {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            box-shadow: 0 4px 20px rgba(72, 187, 120, 0.4);
        }
        
        .record-button.recording {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            animation: recordPulse 1s ease-in-out infinite;
        }
        
        .record-button:hover {
            transform: scale(1.05);
        }
        
        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }
        
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .message.user {
            background: #ebf4ff;
            margin-left: auto;
            text-align: right;
        }
        
        .message.assistant {
            background: #f0fff4;
            margin-right: auto;
        }
        
        .message.system {
            background: #faf5ff;
            text-align: center;
            font-style: italic;
            max-width: 100%;
        }
        
        .processing-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .processing-indicator.show {
            display: block;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .audio-visualizer {
            height: 50px;
            background: #f7fafc;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .audio-bar {
            width: 4px;
            height: 10px;
            background: #667eea;
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤ å®æ—¶å½•éŸ³è¯­éŸ³å¯¹è¯</h1>
        <p>æŒ‰ä½å½•éŸ³æŒ‰é’®è¯´è¯ï¼Œæ¾å¼€è‡ªåŠ¨è¯†åˆ«å¹¶è·å¾—AIå›å¤</p>
    </div>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
            <div id="sessionInfo"></div>
        </div>

        <div class="config-section">
            <div class="input-group">
                <label for="language">è¯­è¨€:</label>
                <select id="language">
                    <option value="zh_cn">ä¸­æ–‡</option>
                    <option value="en_us">è‹±æ–‡</option>
                </select>
            </div>
            <div class="input-group">
                <label for="model">AIæ¨¡å‹:</label>
                <select id="model">
                    <option value="moonshot-v1-8k">moonshot-v1-8k</option>
                    <option value="moonshot-v1-32k">moonshot-v1-32k</option>
                    <option value="moonshot-v1-128k">moonshot-v1-128k</option>
                </select>
            </div>
        </div>

        <div class="record-section">
            <div id="recordModeText">ç‚¹å‡»å½•éŸ³ï¼Œå®æ—¶è¯†åˆ«</div>
            <button class="record-button" id="recordButton">ğŸ¤</button>
            <div id="recordingStatus">ç‚¹å‡»å¼€å§‹å½•éŸ³</div>
            
            <div style="margin-top: 15px;">
                <label>
                    <input type="checkbox" id="streamMode" checked> å®æ—¶æµå¼è¯†åˆ«
                </label>
            </div>
            
            <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
                <!-- éŸ³é¢‘å¯è§†åŒ–æ¡ -->
            </div>
        </div>

        <div class="processing-indicator" id="processingIndicator">
            <div class="spinner"></div>
            <span id="processingText">å¤„ç†ä¸­...</span>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="clearHistory()">æ¸…é™¤å†å²</button>
            <button class="btn btn-secondary" onclick="toggleConnection()">é‡æ–°è¿æ¥</button>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ’¬ å¯¹è¯è®°å½•</h3>
        <div class="chat-container" id="chatContainer">
            <div class="message system">
                ç­‰å¾…è¿æ¥WebSocketæœåŠ¡å™¨...
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let sessionId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeWebSocket();
            setupRecordButton();
            setupMediaRecorder();
        });

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initializeWebSocket() {
            // æ£€æµ‹æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨localhost:3000
            let wsUrl;
            if (window.location.protocol === 'file:') {
                wsUrl = 'ws://localhost:3000/api/realtime-voice';
            } else {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                wsUrl = `${protocol}//${window.location.host}/api/realtime-voice`;
            }
            
            console.log('æ­£åœ¨è¿æ¥åˆ°:', wsUrl);
            updateStatus('connecting', 'è¿æ¥ä¸­...');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateStatus('connected', 'å·²è¿æ¥');
                addSystemMessage('WebSocketè¿æ¥å·²å»ºç«‹');
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                updateStatus('error', 'è¿æ¥é”™è¯¯');
                addSystemMessage('è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
            };
            
            ws.onclose = () => {
                updateStatus('disconnected', 'è¿æ¥æ–­å¼€');
                addSystemMessage('è¿æ¥å·²æ–­å¼€');
                setTimeout(() => {
                    if (!ws || ws.readyState === WebSocket.CLOSED) {
                        initializeWebSocket();
                    }
                }, 5000);
            };
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
            
            switch (message.type) {
                case 'connected':
                    sessionId = message.sessionId;
                    updateSessionInfo(message.sessionId);
                    addSystemMessage(message.message);
                    break;
                    
                case 'recording_started':
                    addSystemMessage('å¼€å§‹å½•éŸ³...');
                    break;
                    
                case 'recording_stopped':
                    addSystemMessage('å½•éŸ³ç»“æŸï¼Œå¤„ç†ä¸­...');
                    showProcessing('å½•éŸ³ç»“æŸï¼Œå¤„ç†ä¸­...');
                    break;
                    
                case 'recording_progress':
                    updateRecordingProgress(message.audioSize, message.duration);
                    break;
                    
                case 'processing':
                    showProcessing(message.message);
                    break;
                    
                case 'transcription_result':
                    hideProcessing();
                    addUserMessage(message.data.text);
                    showProcessing('æ­£åœ¨ç”ŸæˆAIå›å¤...');
                    break;
                    
                case 'complete_result':
                    hideProcessing();
                    addUserMessage(message.data.transcription.text);
                    addAssistantMessage(message.data.aiResponse.message);
                    updateSessionInfo(sessionId, message.data.conversationHistory.length);
                    break;
                    
                case 'stream_processing':
                    showProcessing(message.message);
                    break;
                    
                case 'stream_transcription':
                    addPartialTranscription(message.data.text);
                    break;
                    
                case 'final_transcription':
                    clearPartialTranscription();
                    addUserMessage(message.data.text);
                    break;
                    
                case 'stream_complete_result':
                    hideProcessing();
                    clearPartialTranscription();
                    addUserMessage(message.data.transcription.text);
                    addAssistantMessage(message.data.aiResponse.message);
                    updateSessionInfo(sessionId, message.data.conversationHistory.length);
                    addSystemMessage(`å®æ—¶è¯†åˆ«å®Œæˆï¼Œå…±${message.data.transcription.partialResults.length}ä¸ªç‰‡æ®µ`);
                    break;
                    
                case 'stream_error':
                    hideProcessing();
                    addSystemMessage(`æµå¼å¤„ç†é”™è¯¯: ${message.error}`);
                    break;
                    
                case 'error':
                    hideProcessing();
                    addSystemMessage(`é”™è¯¯: ${message.error}`);
                    break;
                    
                case 'history_cleared':
                    clearChatContainer();
                    addSystemMessage('å¯¹è¯å†å²å·²æ¸…é™¤');
                    break;
            }
        }

        // è®¾ç½®å½•éŸ³æŒ‰é’®
        function setupRecordButton() {
            const recordButton = document.getElementById('recordButton');
            const streamModeCheckbox = document.getElementById('streamMode');
            
            // æ›´æ–°æ¨¡å¼æ–‡æœ¬
            function updateModeText() {
                const modeText = document.getElementById('recordModeText');
                const statusText = document.getElementById('recordingStatus');
                
                if (streamModeCheckbox.checked) {
                    modeText.textContent = 'ç‚¹å‡»å½•éŸ³ï¼Œå®æ—¶è¯†åˆ«';
                    if (!isRecording) {
                        statusText.textContent = 'ç‚¹å‡»å¼€å§‹å®æ—¶å½•éŸ³';
                    }
                } else {
                    modeText.textContent = 'æŒ‰ä½å½•éŸ³ï¼Œæ¾å¼€å¤„ç†';
                    if (!isRecording) {
                        statusText.textContent = 'æŒ‰ä½å¼€å§‹å½•éŸ³';
                    }
                }
            }
            
            streamModeCheckbox.addEventListener('change', updateModeText);
            updateModeText();
            
            // ç»Ÿä¸€çš„ç‚¹å‡»/è§¦æ‘¸å¤„ç†
            recordButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (streamModeCheckbox.checked) {
                    // æµå¼æ¨¡å¼ï¼šç‚¹å‡»åˆ‡æ¢
                    toggleRecording();
                }
            });
            
            // æŒ‰ä½æ¨¡å¼äº‹ä»¶ï¼ˆéæµå¼æ¨¡å¼ï¼‰
            recordButton.addEventListener('mousedown', (e) => {
                if (!streamModeCheckbox.checked) {
                    startRecording();
                }
            });
            
            recordButton.addEventListener('mouseup', (e) => {
                if (!streamModeCheckbox.checked) {
                    stopRecording();
                }
            });
            
            recordButton.addEventListener('mouseleave', (e) => {
                if (!streamModeCheckbox.checked && isRecording) {
                    stopRecording();
                }
            });
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            recordButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (streamModeCheckbox.checked) {
                    toggleRecording();
                } else {
                    startRecording();
                }
            });
            
            recordButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!streamModeCheckbox.checked && isRecording) {
                    stopRecording();
                }
            });
        }

        // è®¾ç½®åª’ä½“å½•éŸ³å™¨
        async function setupMediaRecorder() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
                        // å‘é€éŸ³é¢‘æ•°æ®
                        ws.send(event.data);
                    }
                };
                
                // è®¾ç½®éŸ³é¢‘å¯è§†åŒ–
                setupAudioVisualization(stream);
                
            } catch (error) {
                console.error('è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
                addSystemMessage('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        // è®¾ç½®éŸ³é¢‘å¯è§†åŒ–
        function setupAudioVisualization(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // åˆ›å»ºå¯è§†åŒ–æ¡
            const visualizer = document.getElementById('audioVisualizer');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                visualizer.appendChild(bar);
            }
            
            function updateVisualization() {
                if (!isRecording) return;
                
                analyser.getByteFrequencyData(dataArray);
                const bars = visualizer.querySelectorAll('.audio-bar');
                
                for (let i = 0; i < bars.length; i++) {
                    const value = dataArray[i * 4] || 0;
                    const height = Math.max(10, (value / 255) * 50);
                    bars[i].style.height = height + 'px';
                }
                
                requestAnimationFrame(updateVisualization);
            }
            
            updateVisualization();
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        function toggleRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹å½•éŸ³');
                return;
            }
            
            if (!mediaRecorder) {
                addSystemMessage('åª’ä½“å½•éŸ³å™¨æœªåˆå§‹åŒ–');
                return;
            }

            if (isRecording) {
                // å½“å‰æ­£åœ¨å½•éŸ³ï¼Œåœæ­¢å½•éŸ³
                stopRecording();
            } else {
                // å½“å‰æœªå½•éŸ³ï¼Œå¼€å§‹å½•éŸ³
                startStreamRecording();
            }
        }

        // å¼€å§‹æµå¼å½•éŸ³
        function startStreamRecording() {
            isRecording = true;
            updateStatus('recording', 'å®æ—¶å½•éŸ³ä¸­...');
            
            const recordButton = document.getElementById('recordButton');
            recordButton.classList.add('recording');
            recordButton.textContent = 'â¹ï¸';
            
            document.getElementById('recordingStatus').textContent = 'å®æ—¶å½•éŸ³ä¸­... å†æ¬¡ç‚¹å‡»ç»“æŸ';
            document.getElementById('audioVisualizer').style.display = 'flex';
            
            // å‘é€å¼€å§‹å½•éŸ³æ¶ˆæ¯ï¼ˆæµå¼æ¨¡å¼ï¼‰
            ws.send(JSON.stringify({
                type: 'toggle_recording',
                language: document.getElementById('language').value,
                model: document.getElementById('model').value,
                streamMode: true
            }));
            
            // å¼€å§‹å½•éŸ³
            mediaRecorder.start(100); // æ¯100mså‘é€ä¸€æ¬¡æ•°æ®
        }

        // å¼€å§‹å½•éŸ³ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰
        function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹å½•éŸ³');
                return;
            }
            
            if (!mediaRecorder) {
                addSystemMessage('åª’ä½“å½•éŸ³å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            isRecording = true;
            updateStatus('recording', 'å½•éŸ³ä¸­...');
            
            const recordButton = document.getElementById('recordButton');
            recordButton.classList.add('recording');
            recordButton.textContent = 'ğŸ”´';
            
            document.getElementById('recordingStatus').textContent = 'æ­£åœ¨å½•éŸ³... æ¾å¼€ç»“æŸ';
            document.getElementById('audioVisualizer').style.display = 'flex';
            
            // å‘é€å¼€å§‹å½•éŸ³æ¶ˆæ¯
            ws.send(JSON.stringify({
                type: 'start_recording',
                language: document.getElementById('language').value,
                model: document.getElementById('model').value,
                streamMode: false
            }));
            
            // å¼€å§‹å½•éŸ³
            mediaRecorder.start(100); // æ¯100mså‘é€ä¸€æ¬¡æ•°æ®
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            updateStatus('processing', 'å¤„ç†ä¸­...');
            
            const recordButton = document.getElementById('recordButton');
            recordButton.classList.remove('recording');
            recordButton.textContent = 'ğŸ¤';
            
            document.getElementById('recordingStatus').textContent = 'å¤„ç†ä¸­...';
            document.getElementById('audioVisualizer').style.display = 'none';
            
            // åœæ­¢å½•éŸ³
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            // å‘é€åœæ­¢å½•éŸ³æ¶ˆæ¯
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'stop_recording'
                }));
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // æ›´æ–°ä¼šè¯ä¿¡æ¯
        function updateSessionInfo(sessionId, messageCount = 0) {
            document.getElementById('sessionInfo').textContent = 
                `ä¼šè¯: ${sessionId?.substr(-8)} | æ¶ˆæ¯: ${messageCount}`;
        }

        // æ˜¾ç¤ºå¤„ç†æŒ‡ç¤ºå™¨
        function showProcessing(text) {
            const indicator = document.getElementById('processingIndicator');
            const textElement = document.getElementById('processingText');
            textElement.textContent = text;
            indicator.classList.add('show');
        }

        // éšè—å¤„ç†æŒ‡ç¤ºå™¨
        function hideProcessing() {
            const indicator = document.getElementById('processingIndicator');
            indicator.classList.remove('show');
            updateStatus('connected', 'å·²è¿æ¥');
            document.getElementById('recordingStatus').textContent = 'ç‚¹å‡»å¼€å§‹å½•éŸ³';
        }

        // æ›´æ–°å½•éŸ³è¿›åº¦
        function updateRecordingProgress(audioSize, duration) {
            const sizeKB = (audioSize / 1024).toFixed(1);
            const durationSec = (duration / 1000).toFixed(1);
            document.getElementById('recordingStatus').textContent = 
                `å½•éŸ³ä¸­... ${sizeKB}KB, ${durationSec}s`;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message system';
            message.textContent = text;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message user';
            message.innerHTML = `<strong>ğŸ‘¤ æ‚¨:</strong> ${text}`;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
        function addAssistantMessage(text) {
            const chatContainer = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message assistant';
            message.innerHTML = `<strong>ğŸ¤– Kimi:</strong> ${text}`;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'clear_history'
                }));
            }
        }

        // æ¸…é™¤èŠå¤©å®¹å™¨
        function clearChatContainer() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
        }

        // æ·»åŠ éƒ¨åˆ†è¯†åˆ«ç»“æœ
        function addPartialTranscription(text) {
            const chatContainer = document.getElementById('chatContainer');
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºéƒ¨åˆ†ç»“æœå…ƒç´ 
            let partialElement = document.getElementById('partialTranscription');
            if (!partialElement) {
                partialElement = document.createElement('div');
                partialElement.id = 'partialTranscription';
                partialElement.className = 'message user partial';
                partialElement.style.opacity = '0.7';
                partialElement.style.fontStyle = 'italic';
                partialElement.style.border = '2px dashed #667eea';
                chatContainer.appendChild(partialElement);
            }
            
            partialElement.innerHTML = `<strong>ğŸ‘¤ æ‚¨ (å®æ—¶):</strong> ${text}`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ¸…é™¤éƒ¨åˆ†è¯†åˆ«ç»“æœ
        function clearPartialTranscription() {
            const partialElement = document.getElementById('partialTranscription');
            if (partialElement) {
                partialElement.remove();
            }
        }

        // åˆ‡æ¢è¿æ¥
        function toggleConnection() {
            if (ws) {
                ws.close();
            }
            setTimeout(() => {
                initializeWebSocket();
            }, 1000);
        }
    </script>
</body>
</html>